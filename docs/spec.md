# SPEC — *“Sam Catania: Life as a System”*

## 0) High-level context (READ FIRST)

* **Who/What:** This is **Sam Catania’s** personal website. It expresses Sam’s life as a **system of stocks and flows**, with **objectives** overlaying subsets of that system, and **artifacts** attached to specific stocks/objectives.
* **Why:** Visitors should *feel* systems thinking—seeing a calm, continuously-moving diagram that you can pan/zoom, tweak “valves,” and scrub through time (months/years) to view different eras.
* **How:** Minimalist **black & white** aesthetic, **thin lines**, **constant but subtle motion**, **no “mode switch”**—play and reading happen in the same canvas.
* **Interactivity:**

  * **Stocks** (nodes) show a **ticker value** in human units (e.g., Sleep in **hours/night**).
  * **Flows** (edges) are pipes with thickness proportional to a normalized **rate** and occasional “packets” of flow (particles).
  * **Objectives** are **faint chips** (top-right). Hovering a chip **spotlights** everything it encloses; clicking opens details.
  * **Valves** are simple **round handles** on edges to increase/decrease flow *locally* (session only).
  * A **time slider** (months/years) scrubs **snapshots** (overrides), so the view stays focused and never becomes a lifetime hairball.
* **Data sources:**

  * The app ships with a **local seed JSON** (in the repo).
  * Notion databases **exist** (assume present), and a simple **CLI** can export them to a `synced.json` before deploy.
  * At runtime, the app **does not require Notion**; it loads instantly from local JSON and merges `synced.json` if present.
* **Design goals:** simple, durable, bug-light foundation that is **LLM-friendly** to extend.

---

## 1) Architecture & libraries

**Framework:** Next.js (App Router) + React + TypeScript
**Rendering:**

* **SVG** for nodes/edges (DOM accessibility & crisp lines).
* Optional **Pixi.js** canvas *underlay* for flow particles (recommended, can be disabled in reduce-motion).

**Auto-layout:** **ELK (elkjs)** layered layout with grouping (objectives behave as clusters).
**State:** **Zustand** (global store) + **Immer** for immutable updates.
**Animation:** **Framer Motion** for UI panels/micro-transitions; **rAF** loop for ticker drift + particle emission.
**UI:** **shadcn/ui** + **TailwindCSS** (strict B/W palette).
**Hosting:** Vercel.
**Build step:** optional `scripts/notion-pull.ts` to generate `/public/data/synced.json` (Notion IDs and token via env).

---

## 2) Directory scaffold (create exactly)

```
/app
  /layout.tsx
  /page.tsx
  /(components)
    Canvas.tsx
    GraphView.tsx
    StocksLayer.tsx
    FlowsLayer.tsx
    ValvesLayer.tsx
    ObjectivesChips.tsx
    ObjectiveSpotlightOverlay.tsx
    ParticlesLayer.tsx
    RightDrawer.tsx
    Timebar.tsx
    CursorOverlay.tsx
  /(lib)
    domain/types.ts
    domain/normalize.ts
    domain/merge.ts
    layout/elk.ts
    layout/buildGraph.ts
    anim/ticker.ts
    anim/particles.ts
    a11y/aria.ts
    util/format.ts
    util/math.ts
    state/store.ts
    state/selectors.ts
    io/load.ts
/public
  /data/seed.json
  /data/synced.json       # generated by the CLI; safe to be absent
/scripts
  notion-pull.ts          # optional; not used at runtime
```

---

## 3) Data contracts (TypeScript types)

> **LLM note:** Copy these into `lib/domain/types.ts` verbatim. They are the single source of truth for v1.

```ts
export type UnitFormat = "number" | "percent" | "integer" | "decimal";

export type Unit = {
  key: string;            // e.g., "hours/night", "arbUnits", "probability"
  format: UnitFormat;     // how to format displayed numbers
  decimals?: number;      // default 2
};

export type Interval = { start?: string; end?: string | null }; // ISO dates

export type Metric = {
  key: string;            // e.g., "P(girlfriend)", "ShareholderValue"
  value: number;          // displayed number (in its Unit)
  unit?: Unit;
  ci?: number;            // half-width for ± display (optional)
};

export type Stock = {
  id: string;
  title: string;
  unit: Unit;             // real-world units for display (not normalized)
  value: number;          // real value (e.g., Sleep = 7.4 hours/night)
  displayDomain?: [number, number];   // optional (min,max) for normalization
  active: Interval;       // global active range
  driftPerSec?: number;   // small signed delta to make the displayed number gently move
  parentStockId?: string; // optional nesting support (v1: not rendered as nested boxes)
};

export type Flow = {
  id: string;
  from: string;           // Stock.id
  to: string;             // Stock.id
  rate: number;           // real value in flow's own units (arbitrary)
  displayDomain?: [number, number]; // for thickness normalization
  valvePosition?: number; // 0..1 local tweak (session only, default 0.5 meaning "no change")
  active?: Interval;      // global active range
};

export type Objective = {
  id: string;
  title: string;
  description?: string;
  metric?: Metric;        // optional objective metric with CI
  stocks: string[];       // Stock ids enclosed by this objective
  flows: string[];        // Flow ids enclosed by this objective
  parentObjectiveId?: string; // optional nesting (v1: chips rendered flat)
  active?: Interval;
};

export type ArtifactType = "Essay" | "Project" | "Video" | "Image" | "Doc" | "Book";

export type Artifact = {
  id: string;
  title: string;
  type: ArtifactType;
  url?: string;
  date?: string;
  summary?: string;
  coverImageUrl?: string;
  stockIds?: string[];
  objectiveIds?: string[];
};

export type Snapshot = {
  date: string; // "YYYY-MM"
  stockOverrides?: Record<string, Partial<Pick<Stock,"value"|"displayDomain"|"active">>>;
  flowOverrides?: Record<string, Partial<Pick<Flow,"rate"|"displayDomain"|"active">>>;
  objectiveActive?: Record<string, boolean>; // show/hide objective for the snapshot
  milestones?: { id: string; label: string }[];
};

export type SystemData = {
  stocks: Stock[];
  flows: Flow[];
  objectives: Objective[];
  artifacts: Artifact[];
  snapshots: Snapshot[]; // include a "current" snapshot month
};
```

---

## 4) Data loading & precedence

* On app start:

  1. Load `/public/data/seed.json` (required).
  2. If `/public/data/synced.json` exists, **merge** onto seed (by `id` for all entities; last-write-wins).
  3. Apply **snapshot** for the selected month (defaults to latest snapshot by date). Snapshot is a **diff**: only keys listed in `stockOverrides`, `flowOverrides`, and `objectiveActive` are applied.
  4. Apply **local session** overrides (valvePosition changes) on top; session state is not persisted across reloads.

* **Never mutate** the canonical `value` or `rate` based on drift or local play. These are purely visual/session.

* Implement this function in `lib/domain/merge.ts`:

  ```ts
  export function mergeSystemData(seed: SystemData, synced?: SystemData): SystemData { /* ... */ }
  ```

---

## 5) Normalization (units → display sizes)

* **Stocks (node size)** and **Flows (edge thickness)** must look alive even when real values change slowly.
* We **never coerce** real values into 0..1; we compute *display weight* as:

```ts
// Value normalization:
const w = clamp01((realValue - min) / (max - min));

// If displayDomain exists, use it.
// Else compute min/max from robust sample quantiles per snapshot:
//   min = q10, max = q90 (fallback to [minObserved, maxObserved] if narrow).
// This avoids instability from outliers.
```

* **Mapping to pixels:**

  * Node size → `radius = NODE_MIN + w * (NODE_MAX - NODE_MIN)`.

    * `NODE_MIN = 54`, `NODE_MAX = 110` (px circle-equivalent; we still render rounded rects but size by width).
  * Edge thickness → `thickness = EDGE_MIN + easeOutQuad(w) * (EDGE_MAX - EDGE_MIN)`.

    * `EDGE_MIN = 1.0`, `EDGE_MAX = 6.0` (px).

*(These constants are intentionally generous so “slow” values still read as moving.)*

---

## 6) Auto Layout (ELK) — configuration & grouping

* Use `elkjs` client-side. Create clusters for **active objectives** in the current snapshot:

  * Each objective cluster contains its member stocks that are also active at this snapshot.
  * Stocks not in any active objective go to a **Default** cluster.

* **ELK config (Layered):**

  ```ts
  {
    "elk.algorithm": "layered",
    "elk.direction": "RIGHT",
    "elk.spacing.nodeNode": 24,
    "elk.layered.spacing.nodeNodeBetweenLayers": 48,
    "elk.layered.nodePlacement.strategy": "LINEAR_SEGMENTS",
    "elk.layered.considerModelOrder.strategy": "NODES_AND_EDGES",
    "elk.edgeRouting": "ORTHOGONAL",
    "elk.padding": "[top=24,left=24,bottom=24,right=24]"
  }
  ```

* **Node Sizing for ELK:** Provide `width`/`height` from normalized **node size** (see §5).

* **Edge Routing:** Orthogonal with 4px corner radius (we smooth via path builder).

* **Viewport Fitting:** On initial render or time-snapshot change, compute graph bounding box and fit to viewport with a 40px margin. On item selection, animate zoom-to-fit that item and its immediate neighbors.

* **Panning/Zooming:** Use a single `<g>` transform for the entire graph; zoom with wheel + `ctrl/cmd` or trackpad pinch; pan with drag on empty canvas. Always clamp zoom to `[0.5, 3.0]`.

---

## 7) Rendering: layers & z-order

1. **ParticlesLayer** (Pixi canvas, optional; sits *under* SVG)
2. **FlowsLayer** (SVG paths with chevrons)
3. **ValvesLayer** (SVG circles centered on edge midpoints)
4. **StocksLayer** (SVG rounded rects + titles + ticker)
5. **ObjectiveSpotlightOverlay** (SVG translucent box highlights when a chip is hovered)
6. **CursorOverlay** (absolute div for big pixelated cursor)
7. **RightDrawer** (shadcn Sheet; portal to body)
8. **ObjectiveChips** (absolute top-right; minimal faint chips)
9. **Timebar** (absolute bottom; slider + milestones)

**Theme:** black and white only. Use semitransparent blacks for hierarchy (`#000` at 100%, 60%, 30%, 12%). Background is plain white or black (theme toggle).

---

## 8) Interactions (precise rules)

### 8.1 Hover/Focus rules

* **Hover a stock:**

  * Highlight stock outline to 100% opacity; connected flows to 80%; others to 30%.
  * Show a tooltip near node with `title` and formatted `value` + unit.
  * Keyboard **Tab** cycles through stocks, flows, objectives. **Enter** opens the drawer.

* **Hover a flow:**

  * Edge to 100% opacity; its endpoints to 80%; others to 30%.
  * Show tooltip with `from → to`. Do **not** show rate value (UI intentionally hides numbers on flows).

* **Hover an objective chip (top-right list):**

  * Dim entire graph to 30%; turn on **ObjectiveSpotlightOverlay**:

    * Draw a subtle translucent box that encloses the member stocks plus connecting flows (no hard border; 8px feathered inset shadow).
  * Highlight all member stocks/flows to 100%.
  * Tooltip with objective title + metric (e.g., `P(girlfriend) = 0.45 ± 0.20`).

### 8.2 Selection & Drawer

* **Click a stock:** Open **RightDrawer** with:

  * Header: Stock title + unit-badged value (formatted).
  * Body: markdown summary (optional via Notion), linked **Artifacts** (cards).
* **Click an objective chip:** Open RightDrawer with:

  * Header: Objective title + **metric chip** (toggleable).
  * Metric chip toggles **Number view ↔ Mini whisker**:

    * Number view: e.g., `P(girlfriend) = 0.45 ± 0.20`.
    * Whisker: a 60px horizontal line centered on `value`, whiskers show `value ± ci`; a small dot indicates the mean.
  * Body: description, member stocks (pills), flows (as plain list), artifacts (cards).
* **Close drawer:** Esc key or click backdrop.

### 8.3 Valves (flow adjustment)

* Every active flow has a **single circular valve** placed at its geometric midpoint on the routed edge.
* Cursor behavior:

  * Default: **Large pixelated pointer**.
  * When hovering a valve: cursor changes to a **pixelated wrench** glyph.
* Drag interaction:

  * Start drag → capture pointer; show inline tooltip above valve: `Flow rate: [relative %]`.
  * Map horizontal drag Δx to `valvePosition` in [0..1], with deadzone ±8px around start to avoid accidental changes.
  * Update **displayed thickness** by re-running normalization on **(rate * valveMultiplier)** where `valveMultiplier = lerp(0.2, 1.8, valvePosition)`.
  * **Do not** mutate canonical `rate`. Store `valvePosition` in zustand session only.
  * On drop: leave valve where user ended.
* **Reset** button (top bar, textual): clears all `valvePosition` to defaults (0.5), closes tooltips.

### 8.4 Timebar (months/years)

* Bottom-fixed bar with:

  * **Month ticks** grouped by year;
  * **Milestone dots** for current snapshot (`snapshots[].milestones`). Hover shows label.
* Scrubbing rules:

  * Drag handle snaps to nearest **existing snapshot** (we don’t interpolate across missing months in v1).
  * On switch, apply snapshot diffs and **tween** display weights (node sizes + edge thickness) over 300ms.
  * Stocks/flows that become inactive **fade out** over 200ms; those that become active **fade in** over 200ms.
* Default position: latest snapshot (max by `date`).
* Keyboard: Left/Right arrow moves to previous/next snapshot; Home/End jumps to first/last.

### 8.5 Pan & Zoom

* Pan: drag on empty canvas.
* Zoom: trackpad pinch or `Ctrl/Cmd + wheel`.
* Double-click on item: zoom-to-fit item + first-degree neighbors with 40px padding.
* Clamp zoom to `[0.5, 3.0]`; clamp panning to keep at least 30% of graph bbox in view.

### 8.6 Cursor Overlay

* A positioned `<div>` follows OS cursor, drawing a **big pixelated cursor** (SVG).
* When hovering a valve, swap to pixelated wrench icon.
* Respect `prefers-reduced-motion`: if enabled, do not animate cursor; just swap icons.

---

## 9) Animation system

### 9.1 Ticker drift (explained clearly)

* Purpose: keep numbers **gently alive** without suggesting actual real-time updates.
* For each **stock** (and any **objective metric** that opts-in), compute a **displayed value** as:

```ts
// DO NOT modify Stock.value or Objective.metric.value.
// Maintain a per-item drift state: {base: number, phase: number, amplitude: number}

every frame (≈60Hz):
  phase += dt * ω          // ω = 0.6..1.0 radians/sec, randomized per stock once
  target = base + amplitude * sin(phase)
  displayed = lerp(displayed, target, 0.08)   // smooth easing toward target

// Parameters:
amplitude = clamp(0.0005 * |base|, 0.0003, 0.005) // small relative wobble
// This yields movements like +/- 0.003 on values ~1, or +/- 0.01 on values ~7.4
```

* Optionally add **slow bias**: every 8–12 seconds, re-roll a tiny offset (+/- amplitude/3) to avoid obvious periodicity.

### 9.2 Flow particles

* Implement only if `!prefers-reduced-motion`.
* For each routed edge, keep a polyline. Particle emission cadence:

  ```ts
  intervalMs = clamp(1200 - 900 * w, 250, 1200) // w = normalized thickness
  ```
* Particles move along the polyline at speed:

  ```ts
  speed = lerp(40, 140, w) // px/sec
  ```
* Use Pixi to draw 1–2px squares; opacity ramps in/out.

### 9.3 Selection/highlight transitions

* Use Framer Motion variants with durations 120–180ms; ease-out.

---

## 10) Accessibility

* All interactive graph items (`stock`, `flow`, `valve`, `objective chip`, `timebar handle`) must be focusable (`tabIndex=0` or button).
* Provide `aria-label` strings (e.g., “Increase Sleep→Focus rate”).
* **Keyboard map:**

  * Tab/Shift+Tab: cycle focusables.
  * Enter: open drawer (if stock/objective chip).
  * Arrow Left/Right (on timebar): previous/next snapshot.
  * Esc: close drawer.
* High-contrast respects OS preference.
* `prefers-reduced-motion`: disables particles & reduces drift amplitude to 20%.

---

## 11) UI specs (numbers)

* **Typography:** Inter or Space Grotesk.

  * Title (drawer): 20px/28px, 600 weight.
  * Node label: 12px/16px, 500 weight.
  * Ticker under label: 12px/16px mono (system mono), 400 weight.
* **Strokes:**

  * Node outline: 1.5px (100% opacity on hover/selection; 60% default).
  * Flow: 1.0–6.0px (as per normalization). Chevrons are 6px long, spaced 12px.
  * Objective spotlight: 12% black fill, no border.
* **Chips (objectives):** 11px text, 20px height, 8px padding, 20% black bg, 50% on hover.
* **Valves:** 12px diameter circle, 100% black fill at 80% opacity (100% on hover).
* **Timebar:** 44px height; handle 12px circle; milestone dot 6px.

---

## 12) Components (responsibilities)

* `Canvas.tsx`: viewBox, pan/zoom controller, renders child layers.
* `GraphView.tsx`: builds ELK graph from domain, maps to render positions, memoizes.
* `StocksLayer.tsx`: nodes with labels + ticker.
* `FlowsLayer.tsx`: paths and chevrons; path builders round orthogonal corners.
* `ValvesLayer.tsx`: mid-edge handles + drag logic + tooltips.
* `ObjectiveChips.tsx`: list in top-right; hover/selection wiring.
* `ObjectiveSpotlightOverlay.tsx`: draws translucent spotlight region.
* `ParticlesLayer.tsx`: Pixi canvas bound to edge polylines.
* `RightDrawer.tsx`: artifact lists; metric chip toggle (number↔whisker).
* `Timebar.tsx`: snapshot selector & milestones.
* `CursorOverlay.tsx`: pixelated cursor + wrench swap.

---

## 13) State store (Zustand)

```ts
type SessionState = {
  selectedItem?: { kind: "stock"|"flow"|"objective"; id: string } | null;
  hoveredItem?: { kind: "stock"|"flow"|"objective"; id: string } | null;

  // Valve positions keyed by Flow.id (0..1)
  valves: Record<string, number>; 
  setValve: (flowId: string, val: number) => void;
  resetValves: () => void;

  // Time
  snapshotIndex: number; // index into snapshots[]
  setSnapshotIndex: (i: number) => void;

  // Preferences
  reducedMotion: boolean;
};
```

Selectors in `state/selectors.ts` compute:

* Active stocks/flows for current snapshot.
* Display weights for stocks/flows (applying domains, overrides, valve multipliers).
* Spotlight membership for hovered objective chip.

---

## 14) Algorithms (pseudocode)

### 14.1 Graph build & layout

```ts
function buildElkGraph(data: SystemData, snapshotIdx: number) {
  const snap = data.snapshots[snapshotIdx];
  const activeStocks = filterActiveStocks(data.stocks, snap);
  const activeFlows  = filterActiveFlows(data.flows, snap, activeStocks);
  const activeObjectives = filterActiveObjectives(data.objectives, snap);

  // Create ELK nodes for stocks, with width/height from normalized node size.
  // Create ELK groups for objectives (cluster nodes), add member stocks to group.

  // Create ELK edges for flows between stock nodes (only if both endpoints active).
  // Run ELK, return positions and routed edges (orthogonal).
}
```

### 14.2 Display weight

```ts
function weight(value: number, domain?: [number, number], observed?: [number, number]) {
  const [min,max] = domain ?? observed ?? [0,1];
  return clamp01((value - min) / (max - min + 1e-9));
}
```

### 14.3 Valve multiplier

```ts
function valveMultiplier(valvePos: number) {
  return lerp(0.2, 1.8, clamp01(valvePos ?? 0.5)); // 0.5 = neutral
}
```

### 14.4 Chevrons path

* Render chevrons by stroking dashes along the edge path with `marker-end` triangles **or** repeat tiny `<path>` segments positioned every 12px along `pathLength`.

---

## 15) Error & empty states

* If `synced.json` missing: continue with `seed.json`.
* If no snapshots: render a single *implicit* snapshot “current” from data.
* If ELK layout fails: fallback to a **force-direct** layout (d3-force) capped at 500ms, then freeze positions.
* If there are **zero** stocks/flows: show “No data” overlay with a link to reload.

---

## 16) Build & run

* **Dependencies to add:**

  * `elkjs`, `zustand`, `immer`, `framer-motion`, `@radix-ui/react-*` (via shadcn), `pixi.js` (optional), `d3-path` (for path building), `clsx`.
* **Scripts:**

  * `dev`: `next dev`
  * `build`: `next build` (optionally pre-step `node scripts/notion-pull.ts`)
  * `start`: `next start`

---

## 17) Formatting & utilities

* `util/format.ts`:

  * `formatValue(value:number, unit:Unit): string`

    * `format:"percent"` shows e.g., `45%` with `decimals` precision.
    * `format:"decimal"` uses `toFixed(decimals)`.
* `a11y/aria.ts`:

  * Helpers to produce descriptive labels for valves and chips.

---

## 18) RightDrawer content spec

* **Stock drawer:**

  * Header: Title, subtext: `formatValue(stock.value, stock.unit)`
  * Body:

    * “About” (if description fetched from Notion in future)
    * **Artifacts** grid (cards 280px wide):

      * Cover image (if `coverImageUrl`)
      * Title → link (opens in new tab)
      * Type + date + short summary (2 lines clamp)
* **Objective drawer:**

  * Header: Title + **Metric chip** (toggle)

    * **Number view:** `${metric.key} = ${value} ± ${ci}` (format with unit if present)
    * **Whisker view:** 60px line with tick at `value`, whiskers at `value±ci` (if `ci` present; otherwise show a dot only).
  * Body: description; **Member stocks** (pills with current formatted values); **Artifacts** grid.

---

## 19) Top bar & Timebar

* **Top bar** (overlay text only, no background):

  * Left: “**Sam Catania** — Life as a System”
  * Right: “Reset · Light/Dark” (text buttons)
* **Timebar** (bottom):

  * Snapshots sorted by `date`.
  * Milestones as small circles; hover tooltip.

---

## 20) Theming (Tailwind tokens)

* Background: `bg-white` (light), `bg-black` (dark)
* Foreground: `text-black` / `text-white`
* Lines default: `stroke-black/60` (light), `stroke-white/60` (dark)
* Hovers/active to `stroke-*-100` equivalents (full).
* Chips: `bg-black/15` (light), `bg-white/15` (dark).

---

## 21) Acceptance checklist (QA)

* [ ] App loads from `seed.json` with **no network** and renders a graph.
* [ ] Changing snapshot via timebar switches visibility & values and **tweens** sizes.
* [ ] Hovering an objective chip **spotlights** its subgraph; others dim to 30%.
* [ ] Clicking a stock opens a drawer with formatted value and artifacts list placeholder.
* [ ] Valves drag horizontally, thickness changes in real time; **Reset** restores defaults.
* [ ] Tickers **visibly wobble** in place (drift) but **real values** (in store) stay constant.
* [ ] `prefers-reduced-motion` disables particles; reduces drift amplitude.
* [ ] Keyboard: Tab focuses valves/stocks/objectives; Enter opens; Esc closes; Left/Right moves snapshots.
* [ ] Graph auto-fits viewport; double-click zooms to selection; pan/zoom bounds enforced.
* [ ] No console errors; reflows under 16ms; layout under 50ms for 50 nodes/80 edges.

---

## 22) Example `seed.json` (place in `/public/data/seed.json`)

```json
{
  "stocks": [
    { "id": "sleep", "title": "Sleep", "unit": {"key":"hours/night","format":"decimal","decimals":2}, "value": 7.40, "displayDomain": [5,9], "active":{"start":"2020-01-01"}, "driftPerSec": 0.002 },
    { "id": "focus", "title": "Focus", "unit": {"key":"arbUnits","format":"decimal","decimals":2}, "value": 0.58, "displayDomain": [0,1], "active": {} },
    { "id": "work", "title": "Work: Notion Marketplace", "unit": {"key":"arbUnits","format":"decimal","decimals":3}, "value": 0.83, "displayDomain": [0,1], "active": {} },
    { "id": "learning", "title": "Learning & R&D", "unit": {"key":"arbUnits","format":"decimal"}, "value": 0.52, "displayDomain": [0,1], "active": {} },
    { "id": "friendship", "title": "Friendship", "unit": {"key":"arbUnits","format":"decimal"}, "value": 0.66, "displayDomain": [0,1], "active": {} },
    { "id": "play", "title": "Play/Exploration", "unit": {"key":"arbUnits","format":"decimal"}, "value": 0.44, "displayDomain": [0,1], "active": {} }
  ],
  "flows": [
    { "id": "f1", "from": "sleep", "to": "focus", "rate": 0.35, "displayDomain": [0,1] },
    { "id": "f2", "from": "focus", "to": "work", "rate": 0.50, "displayDomain": [0,1] },
    { "id": "f3", "from": "learning", "to": "work", "rate": 0.18, "displayDomain": [0,1] },
    { "id": "f4", "from": "friendship", "to": "play", "rate": 0.18, "displayDomain": [0,1] },
    { "id": "f5", "from": "play", "to": "learning", "rate": 0.10, "displayDomain": [0,1] }
  ],
  "objectives": [
    { "id": "o1", "title": "Get promoted at work", "metric": { "key":"PromotionLikelihood", "value": 0.37, "unit": {"key":"probability","format":"percent","decimals":0}, "ci": 0.12 }, "stocks": ["focus","work"], "flows": ["f2"], "active": {} },
    { "id": "o2", "title": "Get a girlfriend", "metric": { "key":"P(girlfriend)", "value": 0.45, "unit": {"key":"probability","format":"percent","decimals":0}, "ci": 0.20 }, "stocks": ["friendship","play"], "flows": ["f4"], "active": {} }
  ],
  "artifacts": [],
  "snapshots": [
    { "date": "2024-06", "stockOverrides": {"learning":{"value":0.70}, "work":{"value":0.55}}, "flowOverrides": {"f3":{"rate":0.45}}, "objectiveActive": {"o1": false, "o2": true}, "milestones": [{"id":"mA","label":"Explored AI ideas"}] },
    { "date": "2025-10", "objectiveActive": {"o1": true, "o2": true} }
  ]
}
```

---

## 23) Future (P2) backlog (tracked but not in v1)

* “Curiosity” button: stochastic perturbations to valve positions for playful bumps.
* Freeze-frame poster export (SVG → PNG).
* 3D book model popover for Artifact type “Book”.
* Force layout switch + relayout animation.
* LLM “future projection” when slider moves past latest snapshot.

---

## 24) Implementation order (for the LLM)

1. **Scaffold** Next.js app, Tailwind, shadcn, zustand, elkjs.
2. Implement **types**, **formatters**, and **seed loader**; render static list of stocks (no graph).
3. Add **normalization** and **ELK layout**; render nodes and edges.
4. Add **pan/zoom**, **timebar**, and **snapshot switching**.
5. Add **hover/selection**, **RightDrawer**, and **objective chips** + spotlight overlay.
6. Add **valves** with local session state + **Reset**.
7. Add **ticker drift**, and **particles** (skip if reduced-motion).
8. Polish accessibility and keyboard nav.
9. QA against acceptance checks.

---

### That’s the full v1 spec.

If you want, I can now generate the **initial code skeleton** (files, types, stubbed components, and the ELK integration) directly in the next message so you can paste into Cursor and run `npm run dev` immediately.
